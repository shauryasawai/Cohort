<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Your Social Media Post</title>
    <style>
        /* General body styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            color: #333;
        }

        h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        /* Canvas styling */
        canvas {
            border: 4px solid #2c3e50;
            margin-bottom: 20px;
            border-radius: 15px;
            cursor: grab;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Textarea styling */
        textarea {
            width: 80%;
            max-width: 600px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            margin: 10px 0;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            border-color: #28a745;
            outline: none;
        }

        /* Button, input, and select styling */
        button, input, select {
            margin: 10px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        button {
            background-color: #28a745;
            color: white;
        }

        button:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        input[type="color"] {
            padding: 5px;
            height: 40px;
            width: 60px;
            border-radius: 8px;
            border: 2px solid #2c3e50;
        }

        input[type="range"] {
            width: 150px;
        }

        /* Controls container styling */
        #controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        /* Green button styling */
        .btn-green {
            background-color: #28a745;
            color: white;
        }

        .btn-green:hover {
            background-color: #218838;
        }

        /* Sticker and template container styling */
        .element-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .element-container h3 {
            width: 100%;
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .element-container img {
            width: 100px;
            height: 100px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .element-container img:hover {
            border-color: #28a745;
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Form styling */
        form {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 800px;
        }

        form label {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-top: 10px;
            display: block;
        }

        form textarea {
            width: 90%;
            max-width: 600px;
        }

        /* Resize handle styling */
        .resize-handle {
            width: 10px;
            height: 10px;
            background: #28a745;
            border: 1px solid #fff;
            position: absolute;
            cursor: se-resize;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            #controls {
                flex-direction: column;
                align-items: center;
            }

            .element-container img {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>

    <h1>Edit Your Social Media Post</h1>

    <!-- Canvas for drawing the post -->
    <canvas id="canvas" width="800" height="1000"></canvas>

    <div class="image-container">
        <h3>üñºÔ∏è</h3>        
        <label for="imagePrompt">üîç Enter Image Prompt:</label>
        <input type="text" id="imagePrompt" placeholder="Enter a theme, e.g., beach resort">
        <button onclick="regenerateImage()">üîÑ Generate New Image</button>
    </div>

    <!-- Controls for customizing the post -->
    <div id="controls">
        <input type="file" id="uploadLogo" accept="image/*">
        <input type="color" id="bgColor" value="#ffffff">
        <input type="text" id="customText" placeholder="Enter text">
        <button class="btn-green" onclick="addText()">Add Text</button>
        <label for="textColor">Text Color:</label>
        <input type="color" id="textColor" value="#000000">
        <label for="textSize">Text Size:</label>
        <input type="range" id="textSize" min="10" max="100" value="20">
        <button class="btn-green" onclick="removeSelected()">Remove Selected</button>
        <button class="btn-green" onclick="undo()">Undo</button>
    </div>

    <!-- Stickers -->
    <div class="element-container">
        <h3>Stickers</h3>
        <img src="../../stickers/eid1.png" alt="Star Sticker" onclick="addSticker('../../stickers/eid1.png')">
        <img src="../../stickers/eid2.png" alt="Heart Sticker" onclick="addSticker('../../stickers/eid2.png')">
        <img src="../../stickers/eid3.png" alt="Fire Sticker" onclick="addSticker('../../stickers/eid3.png')">
        <img src="../../stickers/eid4.png" alt="Like Sticker" onclick="addSticker('../../stickers/eid4.png')">
        <img src="../../stickers/friday1.png" alt="Fire Sticker" onclick="addSticker('../../stickers/friday1.png')">
        <img src="../../stickers/friday2.png" alt="Smile Sticker" onclick="addSticker('../../stickers/friday2.png')">
        <img src="../../stickers/friday3.png" alt="Check Sticker" onclick="addSticker('../../stickers/friday3.png')">
        <img src="../../stickers/holi1.png" alt="Star Sticker" onclick="addSticker('../../stickers/holi1.png')">
        <img src="../../stickers/holi2.png" alt="Heart Sticker" onclick="addSticker('../../stickers/holi2.png')">
        <img src="../../stickers/holi3.png" alt="Like Sticker" onclick="addSticker('../../stickers/holi3.png')">
    </div>

    <!-- Upload Custom Sticker -->
    <div id="controls">
        <input type="file" id="uploadSticker" accept="image/*">
        <button class="btn-green" onclick="addCustomSticker()">Add Custom Sticker</button>
    </div>

    <!-- Color Filters -->
    <div id="controls">
        <label for="filter">Apply Filter:</label>
        <select id="filter" onchange="applyFilter(this.value)">
            <option value="none">None</option>
            <option value="grayscale">Grayscale</option>
            <option value="sepia">Sepia</option>
            <option value="invert">Invert</option>
            <option value="saturate">Saturate</option>
        </select>
    </div>

    <!-- Form for finalizing the post -->
    <form method="POST" action="{% url 'finalize_post' %}">
        {% csrf_token %}
        
        <input type="hidden" name="product_name" value="{{ product_name }}">
        <input type="hidden" id="finalImage" name="image_url" value="{{ image_url }}">
        
        <p><strong>Product Name:</strong> {{ product_name }}</p>

        <label for="edited_caption"><strong>Edit Caption:</strong></label><br>
        <textarea name="edited_caption" rows="4">{{ caption }}</textarea><br><br>

        <label for="edited_hashtags"><strong>Edit Hashtags:</strong></label><br>
        <textarea name="edited_hashtags" rows="2">{{ hashtags }}</textarea><br><br>

        <button class="btn-green" type="button" onclick="saveAndSubmit()">Finalize Post</button>
    </form>

    <script>
        // Canvas and context setup
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const finalImageInput = document.getElementById("finalImage");

        // Array to hold all elements on the canvas
        let elements = [];
        let selectedElement = null;
        let offsetX, offsetY, dragging = false;
        let resizing = false;

        // History for undo functionality
        let history = [];
        const MAX_HISTORY_LENGTH = 20; // Limit history to 20 states

        // Load AI-generated image
        const imageUrl = "{{ image_url }}";
        const img = new Image();
        img.crossOrigin = "Anonymous"; // Important for saving canvas with external images
        img.src = imageUrl;
        img.onload = () => {
            elements.push({ type: "image", img: img, x: 0, y: 0, width: canvas.width, height: canvas.height });
            saveState(); // Save initial state
            drawCanvas();
        };

        // Function to save the current state to history
        function saveState() {
            if (history.length >= MAX_HISTORY_LENGTH) {
                history.shift(); // Remove the oldest state if history exceeds limit
            }
            history.push(JSON.stringify(elements)); // Save a deep copy of the elements array
        }

        // Function to undo the last change
        function undo() {
            if (history.length > 1) {
                history.pop(); // Remove the current state
                elements = JSON.parse(history[history.length - 1]); // Revert to the previous state
                drawCanvas();
            } else {
                alert("No more states to undo.");
            }
        }

        // Function to redraw the canvas
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = document.getElementById("bgColor").value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            elements.forEach(element => {
                if (element.type === "image") {
                    ctx.drawImage(element.img, element.x, element.y, element.width, element.height);
                } else if (element.type === "text") {
                    ctx.fillStyle = element.color;
                    ctx.font = element.font;
                    ctx.fillText(element.text, element.x, element.y);
                }
            });

            // Draw resize handle if an image is selected
            if (selectedElement && selectedElement.type === "image") {
                ctx.strokeStyle = "#28a745";
                ctx.strokeRect(selectedElement.x, selectedElement.y, selectedElement.width, selectedElement.height);
                drawResizeHandle(selectedElement.x + selectedElement.width, selectedElement.y + selectedElement.height);
            }
        }

        // Draw resize handle
        function drawResizeHandle(x, y) {
            ctx.fillStyle = "#28a745";
            ctx.fillRect(x - 5, y - 5, 10, 10);
        }

        // Change Background Color
        document.getElementById("bgColor").addEventListener("input", function () {
            saveState();
            drawCanvas();
        });

        // Add Text
        function addText() {
            const text = document.getElementById("customText").value;
            const color = document.getElementById("textColor").value;
            const size = document.getElementById("textSize").value;
            
            if (text.trim() === "") {
                alert("Please enter some text first");
                return;
            }
            
            elements.push({ type: "text", text, x: 50, y: 50, font: `bold ${size}px Arial`, color, size });
            saveState();
            drawCanvas();
        }

        // Upload Logo
        document.getElementById("uploadLogo").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function (e) {
                const logoImg = new Image();
                logoImg.src = e.target.result;
                logoImg.onload = function () {
                    elements.push({ type: "image", img: logoImg, x: 100, y: 100, width: 100, height: 100 });
                    saveState();
                    drawCanvas();
                };
            };
            reader.readAsDataURL(file);
        });

        // Add Sticker from URL
        function addSticker(stickerUrl) {
            const stickerImg = new Image();
            stickerImg.crossOrigin = "Anonymous"; // Important for saving canvas with external images
            stickerImg.src = stickerUrl;
            stickerImg.onload = function () {
                // Calculate aspect ratio to maintain proportions
                const aspectRatio = stickerImg.width / stickerImg.height;
                const defaultSize = 100;
                
                elements.push({
                    type: "image",
                    img: stickerImg,
                    x: canvas.width / 2 - defaultSize / 2, // Center the sticker
                    y: canvas.height / 2 - defaultSize / 2,
                    width: defaultSize,
                    height: defaultSize / aspectRatio,
                    originalWidth: defaultSize,
                    originalHeight: defaultSize / aspectRatio
                });
                saveState();
                drawCanvas();
            };
            stickerImg.onerror = function () {
                console.error("Failed to load sticker:", stickerUrl);
                alert("Failed to load sticker. Please try another one.");
            };
        }

        // Add Custom Sticker from upload
        function addCustomSticker() {
            const fileInput = document.getElementById("uploadSticker");
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a sticker image first");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function (e) {
                const stickerImg = new Image();
                stickerImg.src = e.target.result;
                stickerImg.onload = function () {
                    // Calculate aspect ratio to maintain proportions
                    const aspectRatio = stickerImg.width / stickerImg.height;
                    const defaultSize = 100;
                    
                    elements.push({
                        type: "image",
                        img: stickerImg,
                        x: canvas.width / 2 - defaultSize / 2, // Center the sticker
                        y: canvas.height / 2 - defaultSize / 2,
                        width: defaultSize,
                        height: defaultSize / aspectRatio,
                        originalWidth: defaultSize,
                        originalHeight: defaultSize / aspectRatio
                    });
                    saveState();
                    drawCanvas();
                    fileInput.value = ""; // Clear the file input
                };
            };
            reader.readAsDataURL(file);
        }

        // Apply Color Filter
        function applyFilter(filter) {
            ctx.filter = filter === "none" ? "none" : filter + "(100%)";
            saveState();
            drawCanvas();
        }

        // Handle Dragging and Resizing
        canvas.addEventListener("mousedown", function (e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Check if the user clicked on the resize handle
            if (selectedElement && selectedElement.type === "image") {
                const handleX = selectedElement.x + selectedElement.width;
                const handleY = selectedElement.y + selectedElement.height;
                if (mouseX >= handleX - 10 && mouseX <= handleX + 10 && mouseY >= handleY - 10 && mouseY <= handleY + 10) {
                    resizing = true;
                    return;
                }
            }

            // Check if the user clicked on an element
            for (let i = elements.length - 1; i >= 0; i--) {
                const element = elements[i];

                if (element.type === "image") {
                    if (
                        mouseX >= element.x &&
                        mouseX <= element.x + element.width &&
                        mouseY >= element.y &&
                        mouseY <= element.y + element.height
                    ) {
                        selectedElement = element;
                        offsetX = mouseX - element.x;
                        offsetY = mouseY - element.y;
                        dragging = true;
                        return;
                    }
                } else if (element.type === "text") {
                    const textWidth = ctx.measureText(element.text).width;
                    if (
                        mouseX >= element.x &&
                        mouseX <= element.x + textWidth &&
                        mouseY >= element.y - element.size &&
                        mouseY <= element.y
                    ) {
                        selectedElement = element;
                        offsetX = mouseX - element.x;
                        offsetY = mouseY - element.y;
                        dragging = true;
                        return;
                    }
                }
            }
        });

        canvas.addEventListener("mousemove", function (e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (dragging && selectedElement) {
                selectedElement.x = mouseX - offsetX;
                selectedElement.y = mouseY - offsetY;
                drawCanvas();
            } else if (resizing && selectedElement) {
                selectedElement.width = mouseX - selectedElement.x;
                selectedElement.height = mouseY - selectedElement.y;
                drawCanvas();
            }
        });

        canvas.addEventListener("mouseup", function () {
            if (dragging || resizing) {
                saveState(); // Save state after dragging or resizing
            }
            dragging = false;
            resizing = false;
        });

        // Remove selected element
        function removeSelected() {
            if (selectedElement) {
                elements = elements.filter(el => el !== selectedElement);
                selectedElement = null;
                saveState();
                drawCanvas();
            }
        }

        // Update Text Size
        document.getElementById("textSize").addEventListener("input", function () {
            if (selectedElement && selectedElement.type === "text") {
                selectedElement.size = this.value;
                selectedElement.font = `bold ${this.value}px Arial`;
                saveState();
                drawCanvas();
            }
        });

        // Update Text Color
        document.getElementById("textColor").addEventListener("input", function () {
            if (selectedElement && selectedElement.type === "text") {
                selectedElement.color = this.value;
                saveState();
                drawCanvas();
            }
        });

        // Save the canvas as image and submit the form
        function saveAndSubmit() {
            // Convert canvas to data URL
            const dataURL = canvas.toDataURL("image/png");
            // Set the value of the hidden input
            finalImageInput.value = dataURL;
            // Submit the form
            document.querySelector("form").submit();
        }

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        function regenerateImage() {
            let prompt = document.getElementById("imagePrompt").value || "luxury hotel";
        
            fetch(`/generate-image?prompt=${encodeURIComponent(prompt)}`)
                .then(response => response.json())
                .then(data => {
                    let img = new Image();
                    img.crossOrigin = "Anonymous"; // Prevents CORS issues
                    img.src = data.image_url + `?t=${new Date().getTime()}`; // Force image reload
        
                    img.onload = function () {
                        // Clear existing elements and add the new image
                        elements = [{ type: "image", img: img, x: 0, y: 0, width: canvas.width, height: canvas.height }];
        
                        // Save state and redraw canvas
                        saveState();
                        drawCanvas();
                    };
        
                    img.onerror = function () {
                        console.error("Error loading image");
                        alert("Failed to regenerate the image. Please try again.");
                    };
                })
                .catch(error => {
                    console.error("Error fetching image:", error);
                    alert("Error generating image. Please check your connection and try again.");
                });
        }
        
    </script>

</body>
</html>